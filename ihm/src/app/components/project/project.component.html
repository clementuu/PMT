@if (project) {
  <div class="project-container">
    <!-- Project Details Section -->
    <div class="project-header">
      @if (!isEditing) {
          <div class="flex">
            <h1>{{ project.nom }}</h1>
            <div class="flex">
              <button class="btn btn-secondary me-1" type="button" (click)="startEditing()"><i class="bi bi-pencil-square"></i> Modifier</button>
              <button class="btn btn-danger" title="supprimer" type="button" (click)="deleteProject()"><i class="bi bi-trash"></i></button>
            </div>
          </div>
          <p>{{ project.description }}</p>
          <small>Date de fin: {{ project.dateFin | date: 'dd/MM/yyyy' }}</small>
      } @else if (isEditing) {
        <form [formGroup]="projectForm" (ngSubmit)="updateProject()">
          <div class="input-group">
            <label for="nom">Nom du projet:</label>
            <input id="nom" formControlName="nom">
          </div>
          <div class="input-group">
            <label for="description">Description:</label>
            <textarea id="description" formControlName="description" rows="5"></textarea>
          </div>
          <div class="input-group">
            <label for="dateFin">Date de fin:</label>
            <input id="dateFin" type="date" formControlName="dateFin">
          </div>
          <div class="text-center">
            <button class="btn btn-secondary me-1" type="button" (click)="cancelEdit()">Annuler</button>
            <button class="btn btn-primary" type="submit" [disabled]="projectForm.invalid">Enregistrer</button>
          </div>
        </form>
      }
    </div>

    <!-- Task Section -->
    <div class="flex mt-3 mb-2">
      <h3></h3>
      <button class="btn btn-primary" type="button"><i class="bi bi-plus"></i> Nouvelle tâche</button>
    </div>

    <!-- Task Board Section -->
    <div class="task-board" cdkDropListGroup>
      <div class="task-column"
           id="TODO"
           cdkDropList
           [cdkDropListData]="todoTasks"
           (cdkDropListDropped)="drop($event)">
        <h2>À faire</h2>
        @for (task of todoTasks ; track task.id) {
          <div cdkDrag class="task-card" (click)="goToTaskDetail(task.id)">
            <h3>{{ task.nom }}</h3>
            <p>{{ task.description }}</p>
            <small>Échéance: {{ task.dateEcheance | date: 'dd/MM/yyyy' }}</small>
          </div>
        }
      </div>
      <div class="task-column"
           id="IN_PROGRESS"
           cdkDropList
           [cdkDropListData]="inProgressTasks"
           (cdkDropListDropped)="drop($event)">
        <h2>En cours</h2>
        @for (task of inProgressTasks ; track task.id) {
          <div cdkDrag class="task-card" (click)="goToTaskDetail(task.id)">
            <h3>{{ task.nom }}</h3>
            <p>{{ task.description }}</p>
            <small>Échéance: {{ task.dateEcheance | date: 'dd/MM/yyyy' }}</small>
          </div>
        }
      </div>
      <div class="task-column"
           id="DONE"
           cdkDropList
           [cdkDropListData]="doneTasks"
           (cdkDropListDropped)="drop($event)">
        <h2>Terminé</h2>
        @for (task of doneTasks ; track task.id) {
          <div cdkDrag class="task-card" (click)="goToTaskDetail(task.id)">
            <h3>{{ task.nom }}</h3>
            <p>{{ task.description }}</p>
            <small>Échéance: {{ task.dateEcheance | date: 'dd/MM/yyyy' }}</small>
          </div>
        }
      </div>
    </div>

    <!-- Participants Section -->
    <div class="participants-section mt-3">
      <div class="flex">
        <h3>Participants</h3>
      </div>
      <!-- Note: Displaying existing participants will require fetching this data. -->
      <p>L'affichage de la liste des participants actuels sera bientôt disponible.</p>

      <hr>

      <form [formGroup]="addParticipantForm" (ngSubmit)="onAddParticipants()">
        <div class="participant-grid">
          <!-- Grid Header -->
          <div class="grid-header">Utilisateur</div>
          <div class="grid-header">Rôle</div>
          <div class="grid-header"><br></div> <!-- Action column header -->

          <!-- Grid Rows -->
          <div formArrayName="participants" class="grid-rows-container">
            @for (participant of participants.controls; track i; let i = $index) {
              <div [formGroupName]="i" class="grid-row">
                <select title="user" formControlName="userId" class="form-control">
                  <option value="" disabled>-- Sélectionner un utilisateur --</option>
                  @for (user of allUsers; track user.id) {
                    <option [value]="user.id">{{ user.nom }} ({{ user.email }})</option>
                  }
                </select>
              
                <select title="role" formControlName="role" class="form-control">
                  @for (role of availableRoles; track role) {
                    <option [value]="role">{{ role }}</option>
                  }
                </select>
              
                <button title="retirer" type="button" (click)="removeParticipant(i)" class="btn btn-danger btn-sm">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            }
            </div>
          <div class="actions-footer">
            <button type="button" (click)="addParticipant()" class="btn btn-secondary me-1">
              <i class="bi bi-plus"></i> Ajouter une ligne
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="participants.length === 0">Enregistrer</button>
          </div>
        </div>
      </form>
    </div>
  </div>
} @else {
  <div>
    <p>Chargement du projet...</p>
  </div>
}
